String.prototype.format?console.error("String.prototype.format already exists"):String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(t,r){return"undefined"!=typeof e[r]?e[r]:t})},Array.prototype.cutIntoPieces?console.error("Array.prototype.cutIntoPieces already exists"):Array.prototype.cutIntoPieces=function(e){for(var t=[],r=this.slice(0);r.length>0;)t.push(r.splice(0,e));return t};var httpUtils={hashParam:function(e,t){var r=window.location.hash.substring(1),n=r.split("&");if(void 0===t){var a=n.filter(function(t){return t.split("=")[0]===e}).map(function(e){return e.split("=")[1]});return a.length>1?a:a[0]}var i=n.some(function(r,n,a){return r.split("=")[0]===e?(a[n]=e+"="+t,!0):void 0});i||n.push(e+"="+t),window.location.hash="#"+n.join("&")}},search=function(){var e="https://api.vk.com/method/users.get?v=fuckvk&uids={0}&fields=sex,bdate,photo_100,education&callback=?",t="https://api.vk.com/method/friends.get?v=fuckvk&user_id={0}&callback=?",r=function(){return new function(){var e=[],t=[];this.add=function(r){return e.push(r.name),t.push(r),this},this.search=function(r){var n=e.indexOf(r),a=t[n];return a&&a.name!==r?void console.error("search.newTree.search - Нарушение целостности структуры данных (incorrect index)"):a},this.getTree=function(){return t},this.toString=function(){return JSON.stringify(t)},this.getCount=function(){return t.length}}};return{getUsers:function(t,r,n){if(""===t)n();else{t=t.toString().split(",").map(function(e){return e>>0||e}),t=t.filter(function(e,t,r){return r.indexOf(e)==t});var a=t.cutIntoPieces(20),i=a.length,s=[];a.forEach(function(t){$.getJSON(e.format(t),function(e){e.error?r(!1):(i-=1,s=s.concat(e.response),0===i&&r(s))})})}},getFriends:function(e,r,n){$.getJSON(t.format(e),function(e){r(e.response)}).fail(function(e){n(),console.log(e)})},buildTree:function(e,t){search=this;var n=e.depth,a=e.name;return void 0===a||""===a?(console.error("search.buildTree - Пустое имя (options.name)"),void t()):void 0===n||0>=n?(console.error("search.buildTree - Не задана глубина обхода (options.depth)"),void t()):void search.getUsers(a,function(e){var a=1,i=e[0].uid,s=r();return s.add({name:i,data:{depth:1}}),1===n?void t(s):void function o(e,r){var i=arguments;search.getFriends(e[e.length-1],function(c){c&&(r>1&&(a+=c.length),c.forEach(function(t){s.add({name:t,data:{parents:e,depth:n-r}}),r>1&&o(e.concat(t),r-1)})),i=void 0,a-=1,0===a&&t(s)},function(){o.call(void 0,i),i=void 0})}([i],n-1)})},findCommonUsers:function(e,t,r){search=this;var n=t.depth,a=t.name;if(void 0===a||""===a)return console.error("search.findCommonUsers - Пустое имя (options.name)"),void r();if(void 0===n||0>=n)return console.error("search.findCommonUsers - Не задана глубина обхода (options.depth)"),void r();var i=[];search.getUsers(a,function(t){var a=1,s=t[0].uid;!function o(t,n){var s=arguments;search.getFriends(t[t.length-1],function(c){c&&(n>2&&(a+=c.length),c.forEach(function(r){var a=e.search(r);if(a){var s=(a.data.parents||[]).concat(a.name).concat(t.slice().reverse());i.push(s)}n>2&&o(t.concat(r),n-1)})),a-=1,s=void 0,0===a&&r(i)},function(e){o.call(void 0,s),s=void 0})}([s],n)})},convert:function(e,t,r){if(void 0===e||0===e.length)return void r();var n=t.minLength;e=e.filter(function(e,t){return e.length>=n}),e=e.filter(function(e,t,r){return 0===r.filter(function(r,n){return t>n&&e.every(function(t,n){return e[n]===r[n]})}).length}),e=e.sort(function(e,t){return e.length-t.length}),search.getUsers(e,function(t){r({sequences:e,users:t})})}}}(),ui=function(){return{init:function(e){var t=$("div.slider");return 0===t.length?!1:(t.noUiSlider({start:[e.min||3,e.max||4],step:1,connect:!0,range:{min:3,max:7}}),void t.noUiSlider_pips({mode:"steps",density:20}))},length:function(e){var t=$("div.slider");return 0===t.length?!1:e?void t.val([e.min,e.max]):{max:t.val()[1]>>0,min:t.val()[0]>>0}},progress:function(e){var t=$("div.search-result-bar");if(0===t.length)return!1;var r=t.find(".progress-bar");return 0===r.length?!1:(100===e?(t.removeClass("progress-mode"),r.width(0)):(t.addClass("progress-mode"),r.width(e+"%")),!0)},notFound:function(){var e=$("#emptyModal");return 0===e.length?!1:(e.modal(),!0)},enableModes:function(){var e=$("div.search-result-bar label.btn");return 0===e.length?!1:(e.removeClass("disabled"),!0)},searchOn:function(){var e=$(".search-button button");return 0===e.length?!1:(e.removeAttr("disabled"),!0)},searchOff:function(){var e=$(".search-button button#startButton");return 0===e.length?!1:(e.attr("disabled","disabled"),!0)},clean:function(e){var t=e.closest("div.has-feedback");if(0===t.length)return!1;t.removeClass("has-success"),t.removeClass("has-error");var r=t.find("span.glyphicon");if(0===r.length)return!1;r.removeClass("glyphicon-ok"),r.removeClass("glyphicon-remove"),r.removeClass("glyphicon-refresh");var n=t.find(".feedback-user-name");return 0===n.length?!1:(n.text(""),!0)},correct:function(e,t){var r=e.closest("div.has-feedback");if(0===r.length)return!1;r.addClass("has-success"),r.removeClass("has-error");var n=r.find("span.glyphicon");if(0===n.length)return!1;n.addClass("glyphicon-ok"),n.removeClass("glyphicon-remove"),n.removeClass("glyphicon-refresh");var a=r.find(".feedback-user-name");return 0===a.length?!1:(a.text(t),!0)},incorrect:function(e){var t=e.closest("div.has-feedback");if(0===t.length)return!1;t.addClass("has-error"),t.removeClass("has-success");var r=t.find("span.glyphicon");if(0===r.length)return!1;r.addClass("glyphicon-remove"),r.removeClass("glyphicon-ok"),r.removeClass("glyphicon-refresh");var n=t.find(".feedback-user-name");return 0===n.length?!1:(n.text(""),!0)},lookForUser:function(e){var t=e.closest("div.has-feedback");if(0===t.length)return!1;t.removeClass("has-success"),t.removeClass("has-error");var r=t.find("span.glyphicon");return 0===r.length?!1:(r.addClass("glyphicon-refresh"),r.removeClass("glyphicon-ok"),r.removeClass("glyphicon-remove"),!0)},panel:{changePanel:function(e){var t=$("div.result-panels div.result-panel#"+e);return 0===t.length?!1:($("div.result-panels div.result-panel").removeClass("active"),t.addClass("active"),!0)},count:function(e){var t=e.sequences[0].length-2,r=$("div.result-panels div.result-panel#count");if(0===r.length)return!1;r.empty();var n=$("<div>");n.addClass("empty-row");var a=$("<div>");$.each(Array(t),function(){var e=$("<span>");e.addClass("glyphicon glyphicon-user count-icon"),a.append(e)});var i=$("<div>"),s="1"===String(t).slice(-1)?"пользователя":"пользователей";return i.append("<span>Вы знакомы через "+t+" "+s+"</span>"),r.append(n,a,i),!0},write:function(e){var t=$("div.result-panels div.result-panel ul.list-group");return 0===t.length?!1:(t.find("li.list-group-item").remove(),e.sequences.forEach(function(r){r=r.map(function(t){return e.users.filter(function(e){return e.uid===t})[0]});var n=$('<li class="list-group-item">'),a=$('<div class="item-row">');n.append(a),r.forEach(function(e){var t='title="<img src={0}><div>Пол: {1}</div><div>ДР: {2}</div></div>"'.format(e.photo_100,2===e.sex?"мужской":1===e.sex?"женский":"не говорит",e.bdate||"не говорит"),r='href="http://vk.com/id{0}"'.format(e.uid),n=$('<div class="item-cell">');n.append('<a target="_blank" '+t+" "+r+">"+[e.first_name,e.last_name].join(" ")+"</a>"),a.append(n)}),t.append(n)}),t.find("[title]").tooltip({html:!0}),!0)},draw:function(e){var t=$("div.result-panels div.result-panel#draw");if(0===t.length)return!1;t.empty();var r,n,a=e.sequences[0];a&&(r=a[0],n=a[a.length-1]);var i=[];e.sequences.forEach(function(e){e.reduce(function(e,t){return i.push([e,t]),t})}),i=i.filter(function(e,t){return 0===i.filter(function(r,n){return t>n&&e[0]===r[0]&&e[1]===r[1]}).length});var s=i.map(function(e){return{source:e[0],target:e[1]}}),o={};s.forEach(function(t){var r=e.users.filter(function(e){return e.uid===t.source})[0];t.source=o[t.source]||(o[t.source]={name:t.source,label:[r.first_name,r.last_name].join(" ")});var n=e.users.filter(function(e){return e.uid===t.target})[0];t.target=o[t.target]||(o[t.target]={name:t.target,label:[n.first_name,n.last_name].join(" ")})});var c=t.closest(".container").width(),u=.5*c,l=d3.layout.force().nodes(d3.values(o)).links(s).size([c,u]).linkDistance(150).charge(-100).on("tick",function(){h.attr("d",function(e){return"M"+e.source.x+","+e.source.y+" "+e.target.x+","+e.target.y}),f.attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),p.attr("transform",function(e){return"translate("+e.x+","+e.y+")"})}).start(),d=d3.select("div.result-panels div.result-panel#draw").append("svg").attr("width",c).attr("height",u);d.append("defs").selectAll("marker").data([]).enter().append("marker").attr("id",function(e){return e}).attr("viewBox","0 -5 10 10").attr("refX",15).attr("refY",-1.5).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5");var h=d.append("g").selectAll("path").data(l.links()).enter().append("path").attr("class",function(e){return"link"}),f=d.append("g").selectAll("circle").data(l.nodes()).enter().append("circle").attr("r",8).attr("class",function(e){return e.name===r||e.name===n?"red":void 0}).call(l.drag),p=d.append("g").selectAll("text").data(l.nodes()).enter().append("text").attr("x",12).attr("y",3).text(function(e){return e.label}),v=t.closest(".container");return setInterval(function(){c=v.width(),u=.5*c,l.size([c,u]),d.attr("height",u)},2e3),!0}}}}();$(document).ready(function(){var e=httpUtils.hashParam("minLength")>>0;e||(e=3,httpUtils.hashParam("minLength",e));var t=httpUtils.hashParam("maxLength")>>0;t||(t=4,httpUtils.hashParam("maxLength",t)),ui.init({min:e,max:t});var r=[],n=$("input#first");n.bind("keyup",function(e){ui.lookForUser(n),search.getUsers(e.target.value,function(t){switch(t){case!1:ui.incorrect(n),r[0]=void 0;break;default:ui.correct(n,[t[0].first_name,t[0].last_name].join(" ")),r[0]=e.target.value}r[0]&&r[1]&&r[0]!==r[1]?ui.searchOn():ui.searchOff()},function(){ui.searchOff(),ui.clean(n),r[0]=void 0})});var a=$("input#second");a.bind("keyup",function(e){ui.lookForUser(a),search.getUsers(e.target.value,function(t){switch(t){case!1:ui.incorrect(a),r[1]=void 0;break;default:ui.correct(a,[t[0].first_name,t[0].last_name].join(" ")),r[1]=e.target.value}r[0]&&r[1]&&r[0]!==r[1]?ui.searchOn():ui.searchOff()},function(){ui.searchOff(),ui.clean(a),r[1]=void 0})}),$("input").keyup(),$("div.slider#length").change(function(r,n){e=n[0]>>0,t=n[1]>>0,httpUtils.hashParam("minLength",e),httpUtils.hashParam("maxLength",t)}),$(".search-result-bar label.btn-radio").bind("change",function(e){ui.panel.changePanel($(e.target).data("panel"))}),$("button#search").click(function(){var n=(t+1)/2;r[0]!==r[1]&&(ui.progress(0),search.buildTree({name:r[0],depth:Math.ceil(n)},function(t){ui.progress(30);var a={name:r[1],depth:Math.floor(n)};search.findCommonUsers(t,a,function(t){ui.progress(80),search.convert(t,{minLength:e},function(e){ui.progress(90),e?(ui.panel.write(e),ui.panel.count(e),ui.panel.draw(e),ui.enableModes()):ui.notFound(),ui.progress(100)})})}))})});