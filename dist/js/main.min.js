String.prototype.format?console.error("String.prototype.format already exists"):String.prototype.format=function(){var e=arguments;return this.replace(/{(\d+)}/g,function(r,n){return"undefined"!=typeof e[n]?e[n]:r})};var search=function(){var e="https://api.vk.com/method/users.get?uids={0}&callback=?",r="https://api.vk.com/method/friends.get?user_id={0}&callback=?",n=function(){return new function(){var e=[],r=[];this.add=function(n){return e.push(n.name),r.push(n),this},this.search=function(n){var t=e.indexOf(n),a=r[t];return a&&a.name!==n?void console.error("search.newTree.search - Нарушение целостности структуры данных (incorrect index)"):a},this.getTree=function(){return r},this.toString=function(){return JSON.stringify(r)},this.getCount=function(){return r.length}}};return{getUsers:function(r,n){""===r?n(void 0):(r=r.toString().split(",").map(function(e){return Number(e)||e}),r=r.filter(function(e,r,n){return n.indexOf(e)==r}),$.getJSON(e.format(r),function(e){n(e.error?!1:e.response)}))},getFriends:function(e,n,t){$.getJSON(r.format(e),function(e){n(e.response)}).fail(function(e){e(),console.log(e)})},buildTree:function(e,r){search=this;var t=e.depth,a=e.name;return void 0===a||""===a?(console.error("search.buildTree - Пустое имя (options.name)"),void r()):void 0===t||0>=t?(console.error("search.buildTree - Не задана глубина обхода (options.depth)"),void r()):void search.getUsers(a,function(e){var a=1,s=e[0].uid,o=n();return o.add({name:s,data:{depth:1}}),1===t?void r(o):void function i(e,n){var s=arguments;search.getFriends(e[e.length-1],function(c){c&&(n>1&&(a+=c.length),c.forEach(function(r){o.add({name:r,data:{parents:e,depth:t-n}}),n>1&&i(e.concat(r),n-1)})),s=void 0,a-=1,0===a&&r(o)},function(){i.call(void 0,s),s=void 0})}([s],t-1)})},findCommonUsers:function(e,r,n){search=this;var t=r.depth,a=r.name;if(void 0===a||""===a)return console.error("search.findCommonUsers - Пустое имя (options.name)"),void n();if(void 0===t||0>=t)return console.error("search.findCommonUsers - Не задана глубина обхода (options.depth)"),void n();var s=[];search.getUsers(a,function(r){var a=1,o=r[0].uid;!function i(r,t){var o=arguments;search.getFriends(r[r.length-1],function(c){c&&(t>2&&(a+=c.length),c.forEach(function(n){var a=e.search(n);if(a){var o=(a.data.parents||[]).concat(a.name).concat(r.slice().reverse());s.push(o)}t>2&&i(r.concat(n),t-1)})),a-=1,o=void 0,0===a&&n(s)},function(e){i.call(void 0,o),o=void 0})}([o],t)})},convert:function(e,r){if(void 0===e||0===e.length)return void r();var n;n=e.length>1?e.reduce(function(e,r){return e<r.length?e:r.length}):e[0].length,e=e.filter(function(e,r){return e.length===n}),e=e.filter(function(e,r,n){return 0===n.filter(function(n,t){return r>t&&e.every(function(r,t){return e[t]===n[t]})}).length}),search.getUsers(e,function(n){r({sequences:e,users:n})})}}}(),ui=function(){return{showProgress:function(){var e=$("div.search-result-bar");return 0===e.length?!1:(e.addClass("progress-mode"),!0)},hideProgress:function(){var e=$("div.search-result-bar");return 0===e.length?!1:void e.removeClass("progress-mode")},notFound:function(){var e=$("#emptyModal");return 0===e.length?!1:(e.modal(),!0)},enableModes:function(){var e=$("div.search-result-bar label.btn");return 0===e.length?!1:(e.removeClass("disabled"),!0)},searchOn:function(){var e=$("button#modal");return 0===e.length?!1:(e.removeAttr("disabled"),!0)},searchOff:function(){var e=$("button#modal");return 0===e.length?!1:(e.attr("disabled","disabled"),!0)},clean:function(e){var r=e.closest("div.has-feedback");if(0===r.length)return!1;r.removeClass("has-success"),r.removeClass("has-error");var n=r.find("span.glyphicon");return 0===n.length?!1:(n.removeClass("glyphicon-ok"),n.removeClass("glyphicon-remove"),n.removeClass("glyphicon-refresh"),!0)},correct:function(e){var r=e.closest("div.has-feedback");if(0===r.length)return!1;r.addClass("has-success"),r.removeClass("has-error");var n=r.find("span.glyphicon");return 0===n.length?!1:(n.addClass("glyphicon-ok"),n.removeClass("glyphicon-remove"),n.removeClass("glyphicon-refresh"),!0)},incorrect:function(e){var r=e.closest("div.has-feedback");if(0===r.length)return!1;r.addClass("has-error"),r.removeClass("has-success");var n=r.find("span.glyphicon");return 0===n.length?!1:(n.addClass("glyphicon-remove"),n.removeClass("glyphicon-ok"),n.removeClass("glyphicon-refresh"),!0)},lookForUser:function(e){var r=e.closest("div.has-feedback");if(0===r.length)return!1;r.removeClass("has-success"),r.removeClass("has-error");var n=r.find("span.glyphicon");return 0===n.length?!1:(n.addClass("glyphicon-refresh"),n.removeClass("glyphicon-ok"),n.removeClass("glyphicon-remove"),!0)},panel:{changePanel:function(e){var r=$("div.result-panels div.result-panel#"+e);return 0===r.length?!1:($("div.result-panels div.result-panel").removeClass("active"),r.addClass("active"),!0)},count:function(e){var r=e.sequences[0]?e.sequences[0].length-2:"до хрена",n=$("div.result-panels div.result-panel#count");if(0===n.length)return!1;n.empty();var t=$("<div>");t.addClass("empty-row");var a=$("<div>");$.each(Array(r),function(){var e=$("<span>");e.addClass("glyphicon glyphicon-user count-icon"),a.append(e)});var s=$("<div>"),o="1"===String(r).slice(-1)?"пользователя":"пользователей";return s.append("<span>Вы знакомы через "+r+" "+o+"</span>"),n.append(t,a,s),!0},write:function(e){var r=$("div.result-panels div.result-panel ul.list-group");return 0===r.length?!1:(r.find("li.list-group-item").remove(),e.sequences.forEach(function(n){n=n.map(function(r){return e.users.filter(function(e){return e.uid===r})[0]});var t=$('<li class="list-group-item">');n.forEach(function(e){t.append('<a target="_blank" href="http://vk.com/id'+e.uid+'">'+[e.first_name,e.last_name].join(" ")+"</a>")}),r.append(t)}),!0)},draw:function(e){var r=$("div.result-panels div.result-panel#draw");r.empty();var n,t,a=e.sequences[0];a&&(n=a[0],t=a[a.length-1]);var s=[];e.sequences.forEach(function(e){e.reduce(function(e,r){return s.push([e,r]),r})}),s=s.filter(function(e,r){return 0===s.filter(function(n,t){return r>t&&e[0]===n[0]&&e[1]===n[1]}).length});var o=s.map(function(e){return{source:e[0],target:e[1]}}),i={};o.forEach(function(r){var n=e.users.filter(function(e){return e.uid===r.source})[0];r.source=i[r.source]||(i[r.source]={name:r.source,label:[n.first_name,n.last_name].join(" ")});var t=e.users.filter(function(e){return e.uid===r.target})[0];r.target=i[r.target]||(i[r.target]={name:r.target,label:[t.first_name,t.last_name].join(" ")})});var c=r.closest(".container").width(),u=.6*c,l=d3.layout.force().nodes(d3.values(i)).links(o).size([c,u]).linkDistance(150).charge(-100).on("tick",function(){f.attr("d",function(e){return"M"+e.source.x+","+e.source.y+" "+e.target.x+","+e.target.y}),h.attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),v.attr("transform",function(e){return"translate("+e.x+","+e.y+")"})}).start(),d=d3.select("div.result-panels div.result-panel#draw").append("svg").attr("width",c).attr("height",u);d.append("defs").selectAll("marker").data(["suit","licensing","resolved"]).enter().append("marker").attr("id",function(e){return e}).attr("viewBox","0 -5 10 10").attr("refX",15).attr("refY",-1.5).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto").append("path").attr("d","M0,-5L10,0L0,5");var f=d.append("g").selectAll("path").data(l.links()).enter().append("path").attr("class",function(e){return"link"}),h=d.append("g").selectAll("circle").data(l.nodes()).enter().append("circle").attr("r",8).attr("class",function(e){return e.name===n||e.name===t?"red":void 0}).call(l.drag),v=d.append("g").selectAll("text").data(l.nodes()).enter().append("text").attr("x",12).attr("y",3).text(function(e){return e.label})}}}}();$(document).ready(function(){var e=[],r=$("input#first");r.bind("keyup",function(n){ui.lookForUser(r),search.getUsers(n.target.value,function(t){switch(t){case!1:ui.incorrect(r),e[0]=void 0;break;case void 0:ui.clean(r),e[0]=void 0;break;default:ui.correct(r),e[0]=n.target.value}e[0]&&e[1]&&e[0]!==e[1]?ui.searchOn():ui.searchOff()})});var n=$("input#second");n.bind("keyup",function(r){ui.lookForUser(n),search.getUsers(r.target.value,function(t){switch(t){case!1:ui.incorrect(n),e[1]=void 0;break;case void 0:ui.clean(n),e[1]=void 0;break;default:ui.correct(n),e[1]=r.target.value}e[0]&&e[1]&&e[0]!==e[1]?ui.searchOn():ui.searchOff()})}),$("input").keyup(),$("label.btn-radio").bind("change",function(e){ui.panel.changePanel($(e.target).data("panel"))}),$("button#search").click(function(){var r=3;e[0]!==e[1]&&(ui.showProgress(),search.buildTree({name:e[0],depth:r},function(n){var t={name:e[1],depth:r};search.findCommonUsers(n,t,function(e){search.convert(e,function(e){e?(ui.panel.write(e),ui.panel.count(e),ui.panel.draw(e),ui.enableModes()):ui.notFound(),ui.hideProgress()})})}))})});